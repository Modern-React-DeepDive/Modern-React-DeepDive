## 💡 1.5. 이벤트 루프와 비동기 통신의 이해

자바스크립트는 싱글 스레드에서 작동한다. <br>
즉, 기본적으로 자바스크립트는 **한 번에 하나의 작업만 동기 방식으로만 처리**할 수 있다.

- 동기(synchronous): 직렬 방식으로 작업을 처리하는 것을 의미하며, 이 요청이 시작된 이후에는 무조건 응답을 받은 이후에야 비로소 다른 작업을 처리할 수 있다. 그동안 모든 다른 작업들은 대기한다.
  - 매우 직관적으로 다가옴
  - 한 번에 다양한 많은 작업을 처리할 수 없다.
- 비동기(asynchronous): 병렬 방식으로 작업을 처리하는 것을 의미하며, 요청을 시작한 후 이 응답이 오건 말건 상관없이 다음 작업이 이루어지며, 따라서 한 번에 여러 작업이 실행될 수 있다.

js는 분명 싱글 스레드에서 동기 방식으로 작동한다.<br>
하지만 이런 js에서도 많은 양의 비동기 작업이 이루어지고 있다. <br>
비동기 작업이 어떻게 처리되는지 이해하고 비동기 처리를 도와주는 이벤트 루프를 비롯한 다양한 개념에 대해 알고 있어야 한다.

<br>

### 📌 1.5.1. 싱글 스레드 자바스크립트

- 프로세스(process): 프로그램을 구동해 프로그램의 상태가 메모리상에서 실행되는 작업 단위를 의미한다. 즉, **하나의 프로그램 실행은 하나의 프로세스를 가지고 그 프로세스 내부에서 모든 작업이 처리**된다.
- 스레드(thread): 프로세스보다 더 작은 실행 단위
  - 하나의 프로세스에는 여러 개의 스레드를 만들 수 있다.
  - 스레드끼리는 메모리를 공유할 수 있다.
  - 여러 가지 작업을 동시에 수행할 수 있다.
  - 따라서 동시 다발적인 작업을 처리할 수 있게 된다.
  - 하지만 내부적으로 처리가 복잡하다는 단점이 있다.
  - 메모리를 공유해 서로 같은 자원에 접근할 수 있고 여러 작업을 수행하다 보면 같은 자원에 대해 여러 번 수정하는 등 <u>동시성 문제</u>가 발생할 수 있어 이에 대한 처리가 필요하다.
  - 또한, 각각 격리돼 있는 프로세스와는 다르게 하나의 스레드가 문제가 생기면 같은 자원을 공유하는 다른 스레드에도 동시에 문제가 일어날 수 있다.

> ❗️자바스크립트가 싱글 스레드라는 것은 무엇을 의미할까 <br>
> 이는 자바스크립트 코드의 실행이 하나의 스레드에서 순차적으로 이루어지는 것을 의미한다. <br>
> 스레드에서 순차적으로 이루어진다는 것은 코드를 **한 줄 한 줄 실행**한다는 것을 의미하며 궁극적으로 **하나의 작업이 끝나기 전까지는 뒤이은 작업이 실행되지 않는다는 것**을 의미한다.
> 즉, 자바스크립트의 모든 코드는 <u>Run-to-completion, '동기식'으로 한 번에 하나씩 순차적으로 처리</u>된다.

<br>

### 📌 1.5.2. 이벤트 루프란?

이벤트 루프는 자바스크립트 런타임 외부에서 자바스크립트의 비동기 실행을 돕기 위해 만들어진 장치라 할 수 있다. <br>

<span style="background-color:#f5f0ff">**호출 스택과 이벤트 루프**</span>

- 호출 스택(call stack) : 자바스크립트에서 수행해야 할 코드나 함수를 순차적으로 담아두는 스택

```javascript
function bar() {
  console.log("bar");
}

function baz() {
  console.log("baz");
}

function foo() {
  console.log("foo");
  bar();
  baz();
}

foo();
```

위의 예제를 통해서 호출 스택에 쌓이고 비워지는 순서를 살펴보자.

1. foo()가 호출 스택에 먼저 들어간다.
2. foo() 내부에 console.log가 존재하므로 호출 스택에 들어간다.
3. 2의 실행이 완료된 이후에 다음 코드로 넘어간다.(foo() 아직 존재)
4. bar()가 호출 스택에 들어간다.
5. bar() 내부에 console.log가 있으므로 호출 스택에 들어간다.
6. 5의 실행이 완료된 이후에 다음 코드로 넘어간다.(foo(), bar()는 아직 존재)
7. 더 이상 bar()에 남은 것이 없으므로 호출 스택에서 제거된다. (아직 foo() 존재)
8. baz()가 호출 스택에 들어간다.
9. baz()내부에 console.log가 있으므로 호출 스택에 들어간다.
10. 9의 실행이 완료된 이후 다음 코드로 넘어간다. (foo(), baz()는 아직 존재)
11. 더 이상 baz()에 남은 것이 없으므로 호출 스택에서 제거된다 (foo는 아직 존재)
12. 더 이상 foo()에 남은 것이 없으므로 호출 스택에서 제거된다.
13. 이제 호출 스택이 완전히 비워졌다.

위의 예시를 보면 호출스택이 비어 있는지 여부를 확인하는데 이를 바로 **이벤트 루프**라고 하는 것이다.

이벤트 루프는 단순히 이벤트 루프의 단일 스레드 내부에서 이 호출 스택 내부에 수행해야 할 작업이 있는지 확인하고, 수행해야 할 코드가 있다면 자바스크립트 엔진을 사용해 실행한다.

**코드를 실행하는 것**과 **호출 스택이 비어 있는지 확인하는 것** 모두 **단일 스레드**에서 발생하는 점은 알고 있어야 한다.

<br>

<br>

**그렇다면 비동기 작업은 어떻게 실행될까 ❗️**

```javascript
function bar() {
  console.log("bar");
}

function baz() {
  console.log("baz");
}

function foo() {
  console.log("foo");
  setTimeout(bar(), 0);
  baz();
}

foo();
```

1. foo()가 호출 스택에 먼저 들어간다.
2. foo()내부에 console.log가 있으므로 호출 스택에 들어간다.
3. 2의 실행이 완료된 이후에 다음 코드로 넘어간다(foo는 아직 존재)
4. setTimeout(bar(), 0)이 호출 스택에 들어간다.
5. 4번에 대해 타이머 이벤트가 실행되며 **태스크 큐**로 들어가고, 그 대신 **바로 스택에서 제거**된다.
6. baz()가 호출 스택에 들어간다.
7. baz()내부에 console.log가 있으므로 호출 스택에 들어간다.
8. 7의 실행이 완료된 이후에 다음 코드로 넘어간다(아직 foo, baz는 존재)
9. 더 이상 baz에 남은 것이 없으므로 호출 스택에서 제거된다 (foo는 존재)
10. 더 이상 foo에 남은 것이 없으므로 호출 스택에서 제거된다
11. 이제 호출 스택이 완전히 비워졌다.
12. 이벤트 루프가 호출 스택이 비워져 있다는 것을 확인했다. 그리고 **태스크 큐를 확인하니 4번에서 들어갔던 내용이 있어 bar()를 호출 스택에 들여보낸다.**
13. bar()내부에 console.log가 있어 호출 스택에 들어간다
14. 13의 실행이 끝나고 다음 코드로 넘어간다. (아직 bar존재)
15. 더 이상 bar()에 남은 것이 없으므로 호출 스택에서 제거된다.

위의 과정을 통해서 `setTimeout(bar(), 0)`이 정확히 0초 후에 실행된다는 것을 보장하지 못한다는 것을 이해하게 될 것이다.

<br>

<span style="background-color:#f5f0ff">**태스크 큐**</span>

태스크 큐란 실행해야 할 태스크의 집합을 의미한다. <br>
이벤트 루프는 이러한 태스크 큐를 한 개 이상 가지고 있다.<br>

그리고 태스크 큐는 `set` 형태를 띠고 있다.<br>
그 이유는 선택된 큐 중에서 **실행 가능한 가장 오래된 태스크를 가져와야 하기 때문**이다. <br>
하지만 자료구조 큐는 무조건 앞에 있는 것을 선택하는 FIFO 형식이다.

> 🔗 태스크 큐에서 의미하는 **실행해야 할 태스크** <br>
> = **비동기 함수의 콜백 함수나 이벤트 핸들러**

<u>즉, 이벤트 루프의 역할은 호출 스택에 실행 중인 코드가 있는지, 그리고 태스크 큐에서 대기 중인 함수가 있는지 반복해서 확인하는 역할을 한다.</u>

> ❗️그럼 비동기 함수는 누가 수행할까? <br>
> 이러한 작업들은 모두 자바스크립트 코드가 동기식으로 실행되는 메인 스레드가 아닌 **태스크 큐가 할당되는 별도의 스레드**에서 수행된다. <br>
> 이 별도의 스레드에서 태스크 큐에 작업을 할당해 처리하는 것은 **브라우저나 node.js의 역할이다.** <br>
> 즉, 자바스크립트 코드 실행은 싱글 스레드에서 이루어지지만 이러한 외부 Web API 등은 모두 자바스크립트 코드 **외부**에서 실행되고 **콜백이 태스크 큐**로 들어가는 것이다. <br>
> 이벤트 루프는 **호출 스택이 비고, 콜백이 실행 가능한 때가 오면 이것을 꺼내서 수행하는 역할을 하는 것**이다.

<br>

### 📌 1.5.3. 태스크 큐와 마이크로 태스크 큐

- 기존 태스크 큐보다 우선권을 갖는다.
- 대표적인 예시로는 Promise가 있다.
- 마이크로 태스크 큐가 빌 때까지는 기존 태스크 큐의 실행은 뒤로 미루어진다.
- 태스크 큐: setTimeout, setInterval, setImmediate
- 마이크로 태스크 큐: process.nextTick, Promise, queueMicroTask, MutationObserver

<br>

> ❗️그럼 렌더링은 언제 일어날까? <br>
> 마이크로 태스크 큐를 실행한 뒤에 렌더링이 일어난다. 각 마이크로 태스크 큐 작업이 끝날 때마다 한 번씩 렌더링할 기회를 얻게 된다.

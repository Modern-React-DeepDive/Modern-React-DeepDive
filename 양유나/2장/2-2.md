# [2.2] 가상DOM과 리액트파이버

## 2.2.1 DOM과 브라우저 렌더링 과정

DOM : Document Object Model

⇒ 웹페이지에 대한 인터페이스로, 브라우저가 웹페이지의 콘텐츠와 구조를 어떻게 보여줄지에 대한 정보를 담고있다.

1. 브라우저가 사용자가 요청한 주소를 방문해 HTML 파일을 다운로드한다.
2. 브라우저 렌더링 엔진은 HTML을 파싱해 DOM노드로 구성된 트리를 만든다.
3. 2번 과정에서 CSS파일이 있다면 CSS파일도 다운로드 한다.
4. 브라우저의 렌더링 엔진은 CSS도 파싱해 노드로 구성된 트리인 CSSOM을 만든다.
5. 브라우저는 2번에서 만든 DOM노드를 순회한다. 여기서 모든 노드를 방문하는 것이 아닌 사용자 눈에 보이는 노드만 방문한다.
6. 5번에서 제외된, 눈에 보이는 노드를 대상으로 해당 노드에 대한 CSSOM 정보를 찾고 여기서 발견한 CSS를 노드에 적용한다.

이DOM에 CSS를 적용하는 과정은 크게 2가지로 나뉜다.
**레이아웃(layout.reflow)**
각 노드가 브라우저 화면의 어느 좌표에 정확이 나타나는지 계산하는 과정이다. 레이아웃을 거치면 반드시 페인팅도 거친다.

**페인팅(painting)**
레이아웃 단계를 거친 노드에 색과 같은 실제 유효한 모습을 그리는 과정이다.

## 2.2.2 가상 DOM 탄생 배경

앞의 예제에서 살펴본 것처럼 브라우저가 웹페이지를 렌더링하는 과정은 매우 복잡하고 많은 비용이 든다.

가상 DOM은 실제 브라우저의 DOM이 아닌 리액트가 관리하는 가상의 DOM이다.
웹 페이지가 표시해야 할 DOM을 일단 메모리에 저장하고 리액트가 실제 변경에 대한 준비가 완료됐을 때 실제 브라우저의 DOM에 반영한다.
이렇게 DOM계산을 브라우저가 아닌 메모리에서 한다면 실제로는 여러 번 발생했을 렌더링 과정을 최소화하고, 브라우저와 개발자의 부담을 줄일 수 있다.

## 2.2.3 가상 DOM을 위한 아키텍처, 리액트 파이버

가상 DOM과 렌더링 과정 최적화를 가능하게 해주는 것이 리액트 파이버이다. 파이버는 파이버 재조정자(fiber reconciler)가 관리한다.
이는 실제 DOM과 가상 DOM을 비교해 변경 사항을 수집하며, 둘 사이에 차이가 있으면 변경에 관련된 정보를 가지고 있는 파이버를 기준으로 화면에 렌더링을 요청하는 역할을 한다.

<aside>
💡 **파이버의 역할**

- 작업을 닥은 단위로 분할하고 쪼갠다음, 우선순위를매긴다.
- 이러한 작업을 일시 중지하고 나중에 다시 시작할 수 잇다.
- 이전에 했던 작업이 다시 필요하지 않은 경우 폐기 가능하다.
</aside>

=> 이러한 과정은 비동기로 이루어진다.
즉, 메모리 상에서 먼저 수행해 최종 결물만 실제 브라우저 DOM에 적용한다.

- 재조정 : 가상 DOM과 실제DOM비교 알고리즘

- 과거 리액트의 조정 알고리즘은 스택 알고리즘으로 이뤄져있었는데
  이는 동기적으로 이루어져 리액트의 비효율로 이루어졌다.

### 리액트 파이버 트리

파이버 트리는 리액트 내부에서 두 개가 존재한다.

하나는 현재 모습을 담은 파이버 트리이고, 다른 하나는 작업중인 상태를 나타내는 wrokInprogress트리이다.

리액트 파이버의 작업이 끝나면 리액트는 단순히 포인터만 변경해 workInprogress트리를 현재 트리로 바꾼다.

⇒ 더블 버퍼링

### 파이버 작업 순서

일반적인 파이버 노드의 생성 흐름이다.

1. 리액트는 beginWork() 함수를 실행해 파이버 작업을 수행하는데, 더 이상 자식이 없는 파이버를 만날 때까지 트리 형식으로 시작된다.
2. 1번 작업이 끝나면 그 다음 completWork()함수를 실행해 파이버 작업을 완료한다.
3. 형제가 있다면 형제로 넘어간다.
4. 2,3번 작업이 모두 끝났다면 return으로 돌아가 자신의 작업이 완료되었음을 알린다.

#목차

- [1.5 이벤트 루프와 비동기 통신의 이해](#15-이벤트-루프와-비동기-통신의-이해)
  - [1.5.1 싱글 스레드 자바스크립트](#151-싱글-스레드-자바스크립트)
    - [초기의 자바스크립트](#초기의-자바스크립트)
    - [비동기 (asynchronous)](#비동기-asynchronous)
  - [1.5.2. 이벤트 루프란](#152-이벤트-루프란)
    - [Call Stack (호출 스택)](#call-stack-호출-스택)
    - [JS 의 비동기 작업 예시](#js-의-비동기-작업-예시)
    - [태스크 큐](#태스크-큐)
  - [1.5.3 태스크 큐와 마이크로 태스크 큐](#153-태스크-큐와-마이크로-태스크-큐)
    - [마이크로 태스크 큐와 렌더링](#마이크로-태스크-큐와-렌더링)

# 1.5 이벤트 루프와 비동기 통신의 이해

- JS는 `싱글 스레드` 에서 작동한다.
  - ⇒ JS는 기본적으로 한 번에 하나의 작업만 `동기` 방식으로 처리할 수 있다.
- `동기` (synchronous) 방식
  - 직렬 방식의 작업 처리 방식
  - A 요청이 시작되고, A요청에 대한 응답을 받은 이후에 B작업을 수행할 수 있는 방식
  - 진행중인 외의 작업들은 모두 대기 한다.
  - 한 번에 많은 작업을 처리할 수 없다.
- `비동기` (asynchronous) 방식
  - 병렬 방식으로 작업을 처리 한다.
  - 진행중인 작업의 진행도와 상관없이 다른 작업을 동시에 진행 할 수 있다.
  - 한 번에 여러 작업이 수행 된다.

## 1.5.1 싱글 스레드 자바스크립트

- 프로세스 (process)
  - 프로그램의 상태가 메모리 상에서 실행되는 `작업단위` 를 말한다.
  - 하나의 프로그램에는 하나의 프로세스가 할당되어, 프로세스가 프로그램 전체의 작업을 처리 했다.
  - 프로세스 한개로 프로그램의 작업을 처리하기 버거움에 따라 `스레드` 가 등장했다.
- 스레드 (thred)
  - 하나의 프로세스 에서는 여러개의 스레드를 만들 수있다.
  - 스레드 끼리는 메모리를 공유할 수 있으므로, 여러 작업을 동시에 수행 할 수 있다.
- JS의 싱글 스레드
  - 코드의 실행이 `하나의 스레드` 에서 순차적으로 이루어진다. (`동기식`)
  - 코드를 순서에 맞게 한 줄씩 실행하는 것을 의미
  - 하나의 작업이 끝나기 전까지 뒤이은 작업이 수행되지 않는 것을 의미
    (Run-to-Completioin)

### 초기의 자바스크립트

- 초기의 자바스크립트는 웹페이지의 보조기능 만을 수행하는 언어로 설계되었다.
  - 경고창 띄우기, 이미지 띄우기, 폼 사용하기 등 간단한 작업
- 간단 보조기능 수행이 목적이었기 때문에, 멀티 스레드의 복잡한 작업단위 컨트롤과, `동시성 문제` 까지 갖고서 멀티스레드로 빌드할 이유가 없었다.
- 멀티 스레드로 구축했을 시, 여러개의 스레드가 특정 DOM 에 대해 작업을 수행할 때, 그 복잡성을 처리하는데 어려움이 있다.

### 비동기 (asynchronous)

- 동기와 정반대의 개념
- 동기식과 다르게 여러개의 작업이 동시에 수행 될 수 있다.
- JS 는 동기식 언어이지만, 내부 동작구조에 때문에, 비동기식 코드 흐름이 발생한다.

```jsx
console.log("a");
setTimeout(() => {
  console.log("b");
}, 1000);
setTimeout(() => {
  console.log("c");
}, 2000);
console.log("d");

// 출력 결과
// a -> d -> b -> c
```

## 1.5.2. 이벤트 루프란

- ECMA 표준은 아니다.
- 자바스크립트 런타임 외부에서 자바스크립트의 비동기 실행을 돕기 위해 만들어진 장치
- 호출 스택, 태스크 큐가 비어있는지 확인하는 장치
- 이벤트 루프만읜 단일 스레드 내부에서 호출스택에 수행 작업이 있는지 확인
  - 수행해야할 코드가 있다면, JS 엔진을 통해 실행한다.
- 이해에 도움이 되는 글 : [[devh.kr]](https://www.devh.kr/posts/2021-11-24-JavaScript-Visualized-Event-Loop)

### Call Stack (호출 스택)

- JS에서 수행해야할 코드나, 함수를 순차적으로 담아두는 스택(LIFO)
- 호출 스택 예시 코드
  ```jsx
  function bar() {
    console.log("bar");
  }
  function baz() {
    console.log("baz");
  }

  function foo() {
    console.log("foo");
    bar();
    baz();
  }

  foo();
  ```
  1. foo() 가 호출 스택에 먼저 들어간다.
  2. foo() 내부의 console.log(’foo’) 가 호출 스택에 들어간다.
  3. 2의 실행이 완료된 이후 다음 코드로 실행흐름이 넘어간다.(foo()는 아직 호출스택)
  4. bar() 가 호출 스택에들어간다.
  5. bar() 내부의 console.log(’bar’) 가 호출 스택에 들어간다.
  6. 5의 실행이 완료된 이후 다음 코드로 실행 흐름이 넘어간다.
     (foo(), bar()는 아직 스택에 존재)
  7. 더이상 bar()에 남은 코드가 없으므로 bar()는 호출 스택에서 제거
     (아직 foo()는 존재)
  8. baz() 가 호출스택에 들어간다.
  9. baz() 내부의 console.log(’baz’) 가 호출 스택에 들어간다.
  10. 9의 실행이 완료 된 이후, 다음 코드로 실행 흐름이 넘어간다.
      (아직 foo(), baz() 함수는 스택에 존재)
  11. baz()에 남은 코드가 없으므로 스택에서 제거
  12. foo()에 남은 코드가 없으므로 스택에서 제거
  13. 호출 스택 clear

### JS 의 비동기 작업 예시

```jsx
function bar() {
  console.log("bar");
}

function baz() {
  console.log("baz");
}

function foo() {
  console.log("foo");
  setTimeout(bar(), 0);
  baz();
}

foo();

// 출력 결과
// 'foo'
// 'baz'
// 'bar'
```

- 위 코드의 실행 흐름
  1. foo() 가 호출 스택에 들어간다.
  2. foo() 내부에 console.log 가 존재하므로 호출 스택에 들어간다.
  3. 2의 실행이 완료된 이후, 다음 코드로 실행흐름이 넘어간다.
     (foo()는 아직 스택에 존재)
  4. setTimeout(bar(), 0) 이 호출 스택에 들어간다.
  5. 4번의 타이머 이벤트가 실행되며 태스크 큐 (TaskQueue) 에 들어가고 바로 스택에서 제거된다.(`비동기`)
  6. baz() 가 호출 스택에 들어간다.
  7. baz() 내부의 console.log(’baz’) 가 호출 스택에 들어간다.
  8. 7 이 완료된 이후 다음 코드로 실행 흐름이 넘어간다.
  9. baz() 에 더 이상 수행할 코드가 없으므로 호출 스택에서 제거 된다.
     (foo() 는 스택에 아직 존재)
  10. foo() 에 더 이상 수행할 코드가 없으므로 호출 스택에서 제거 된다.
  11. 호출 스택 clear
  12. 이벤트 루프가 호출 스택이 비워짐을 확인하고 태스크 큐를 확인하여 4번에서 등록한 setTimeout 내부의 bar() 함수를 호출 스택에 등록 한다.
  13. bar() 내부의 console.log(’bar’) 가 호출 스택에 들어간다.
  14. 13번 실행이 완료된 후 다음 코드로 실행 흐름이 넘어간다.
  15. 더 이상 bar()에 남은 코드가 없으므로 호출 스택에서 제거 된다.
- 위 코드에서의 이벤트 루프
  - 호출 스택에 실행중인 코드가 있는지 확인
  - 태스크 큐에 대기중인 코드가 있는지 확인
  - 호출 스택이 비었다면?
    - 태스크 큐에서 실행 가능한 가장 `오래된` 작업 부터 순차적으로 꺼내 실행
    - 위 작업또한 태스크 큐가 비워질 때 까지 수행

### 태스크 큐

- Queue 같은 FIFO 방식이 아닌 set의 개념이다.
- 선택된 큐 중에서 실행 가능한 가장 오래된 태스크를 가져온다.
- 자바스크립트 외부에서 처리되는(Web API) 콜백이 들어오는 공간이다.

## 1.5.3 태스크 큐와 마이크로 태스크 큐

- 이벤트 루프는 하나의 마이크로 태스크 큐를 갖는다.
- 태스크 큐와 다른 태스크를 처리한다.
- 마이크로 태스크 큐는 태스크 큐보다 `우선권` 을 가진다.
  - 마이크로 태스크 큐가 비워지기 전까지는 기존 태스크 큐의 실행은 뒤로 미루어진다.
- 태스크 큐
  - setTimeout, setInterval, setImmediate
- 마이크로 태스크 큐
  - process, nextTick, Promises, queueMicroTask, MutationObserver

### 마이크로 태스크 큐와 렌더링

- 태스크 큐를 실행하기 전에 마이크로 태스크 큐를 실행
- 마이크로 태스크 큐를 실행한뒤에 렌더링이 발생
- ⇒ 각 마이크로 태스크 큐의 작업이 끝날 때마나 렌더링이 기회를 얻게 된다.
- 브라우저 렌더링 작업은 마이크로 태스크 큐와 태스크 큐의 실행 사이에서 일어난다.
